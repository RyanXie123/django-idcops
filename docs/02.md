# 编写自定义 django-admin 命令

​之前应用户要求，给 idcops 设备信息新增一个设备高度的字段（Height）单位为U（1U=1.75英寸[4.445公分]）。
这个字段是根据设备当前占用的U位数量来动态计算并写入数据库的，方便一次性从数据库直接查询出来从而提升系统的性能。
上面的场景，引出了本文主题，用户升级系统之后，如何能通过命令来修复设备信息中旧设备信息的设备高度。


**按要求创建命令目录结构**

给 django 应用加命令其实很简单，只需要在应用程序中添加一个 management/commands 目录。Django 会给目录下的每个 Python 模块注册一个 manage.py 命令，这个命令的名字不以下划线开头。例如：

```python
idcops/
    __init__.py
    models.py
    management/
        __init__.py
        commands/
            __init__.py
            _private.py
            fixdevicedata.py
    tests.py
    views.py
```
- `_private.py` 模块将不会作为管理命令使用。
- `fixdevicedata.py` 必须定义 Command 类，该类继承自 BaseCommand 或其 子类。


**编写自定义命令**

以下是 `fixdevicedata.py` 自定义 django-admin 命令的源码：
```python
from queue import Queue
from threading import Thread

from django.core.management.base import BaseCommand, CommandError
from django.core.paginator import Paginator

from idcops.models import Device


class Command(BaseCommand):
    help = "更新所有设备的高度(U)、U位范围"

    batch_size = 256

    def add_arguments(self, parser):
        parser.add_argument(
            '--size', type=int, action='store',
            dest='size', default=self.batch_size,
            help=f"指定每个线程处理多少条设备信息，默认是: {self.batch_size}/thread",
        )

    def fix_device_height(self, obj):
        # 主要业务逻辑
        height = obj.units.all().count()
        Device.objects.filter(pk=obj.pk).update(height=height)
        Device.objects.filter(pk=obj.pk).update(urange=obj.list_units())

    def handle(self, *args, **options):
        per_page = options['size']
        objects = Device.objects.filter()
        page = Paginator(objects, per_page=per_page)
        object_list = page.object_list
        try:
            if object_list.exists():
                q = Queue()

                def worker():
                    while True:
                        if q.empty():
                            return
                        else:
                            item = q.get()
                            self.fix_device_height(item)
                            q.task_done()
                for obj in object_list:
                    q.put(obj)
                threads = list()
                [
                    threads.append(Thread(target=worker, daemon=True))
                    for _ in range(page.num_pages)
                ]
                [t.start() for t in threads]
                [t.join() for t in threads]
                print(
                    f"threads number: {len(threads)} ({per_page}/thread), total: {page.count}"
                )
            else:
                print('No objects')
        except CommandError as e:
            raise(e)
```
- `add_arguments` 给命令添加一个可选参数 `size`
- 巧妙利用 Django 分页，配合 `queue` 多线程处理业务逻辑


**自定义命令效果**

1. 打印出帮助信息：

```powershell
(env) PS D:\Personal\django-idcops> python .\manage.py fixdevicedata -h      
usage: manage.py fixdevicedata [-h] [--size SIZE] [--version] [-v {0,1,2,3}]
                               [--settings SETTINGS] [--pythonpath PYTHONPATH]
                               [--traceback] [--no-color]

更新所有设备的高度(U)、U位范围

optional arguments:
  -h, --help            show this help message and exit
  --size SIZE           指定每个线程处理多少条设备信息，默认是: 256/thread
  --version             show program's version number and exit
  -v {0,1,2,3}, --verbosity {0,1,2,3}
                        Verbosity level; 0=minimal output, 1=normal output,
                        2=verbose output, 3=very verbose output
  --settings SETTINGS   The Python path to a settings module, e.g.
                        "myproject.settings.main". If this isn't provided, the
                        DJANGO_SETTINGS_MODULE environment variable will be
                        used.
  --pythonpath PYTHONPATH
                        A directory to add to the Python path, e.g.
                        "/home/djangoprojects/myproject".
  --traceback           Raise on CommandError exceptions
  --no-color            Don't colorize the command output.
(env) PS D:\Personal\django-idcops> 
```

2. 执行自定义命令效果：

```powershell
(env) PS D:\Personal\django-idcops> python .\manage.py fixdevicedata --size 2
threads number: 4 (2/thread), total: 7
(env) PS D:\Personal\django-idcops> python .\manage.py fixdevicedata         
threads number: 1 (256/thread), total: 7
```
1. 一共7条数据，共启动了4个线程，每个线程能处理2条数据
2. 一共7条数据，共启动了1个线程，每个线程能处理256条数据


**总结：**

Django 会给目录下的每个 Python 模块注册一个 manage.py 命令。所以，一个模块只做一类命令的业务。
批量业务数据量比较大，可以使用多线程来加速业务的处理。

1